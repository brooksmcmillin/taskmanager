name: Claude Reviews

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  code-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Minimize previous review comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}
          MARKER="<!-- claude-code-review -->"

          # Find the most recent comment containing our marker
          COMMENT_NODE_ID=$(gh api "repos/${REPO}/issues/${PR_NUMBER}/comments" \
            --paginate \
            --jq "[.[] | select(.body | contains(\"${MARKER}\"))] | last | .node_id // empty" 2>/dev/null)

          if [ -n "$COMMENT_NODE_ID" ]; then
            echo "Minimizing previous code review comment: $COMMENT_NODE_ID"
            gh api graphql -f query='
              mutation {
                minimizeComment(input: {subjectId: "'"$COMMENT_NODE_ID"'", classifier: OUTDATED}) {
                  minimizedComment { isMinimized }
                }
              }' 2>/dev/null || echo "Warning: failed to minimize comment"
          else
            echo "No previous code review comment found"
          fi

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_bots: "dependabot[bot]"
          prompt: |
            You are a code reviewer. Review this pull request for code quality, correctness, and maintainability.

            Use the repository's CLAUDE.md for guidance on style and conventions.

            ## Comment Marker

            You MUST start your review comment with exactly this HTML comment on its own line:
            `<!-- claude-code-review -->`

            This marker is used to track and manage review comments across pushes. Do not omit it.

            ## Reading Previous Feedback

            Before writing your review, read all existing bot comments on this PR (including minimized ones) to understand what was previously flagged:

            ```
            gh api "repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" --paginate --jq '.[] | select(.user.type == "Bot") | "\n--- Comment from \(.created_at) ---\n\(.body)"'
            gh api "repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments" --paginate --jq '.[] | select(.user.type == "Bot") | "\n--- Comment on \(.path) from \(.created_at) ---\n\(.body)"'
            ```

            ## Formatting Rules

            Compare the current code against previously flagged issues and categorize:

            - **Previously flagged + now fixed** → show with ~~strikethrough~~ and a "Fixed" note
            - **Previously flagged + still present** → reference briefly without re-explaining
            - **New issues** → standard formatting with full explanation

            Structure your review using these sections (omit any section that has no items):

            ### Resolved
            Items previously flagged that are now fixed, shown with ~~strikethrough~~. Example:
            - ~~Missing error handling in `parse_config()`~~ — Fixed

            ### Still Open
            Previously flagged items **within the PR's changed code** that remain unaddressed.
            Do NOT include pre-existing issues outside the PR's scope here.

            ### New Issues
            Newly discovered problems **that must be fixed before merge**. Full explanation required.

            ### Suggestions
            Non-blocking observations: minor improvements, follow-up items, style preferences,
            or pre-existing issues noticed outside the PR scope. These do not block merge.

            If everything is clean and there are no issues in any category, post a short "All clear" message (still include the marker).

            ## Review Focus Areas
            - Correctness: logic errors, edge cases, error handling
            - Maintainability: readability, structure, naming
            - Style: consistency with project patterns

            Use `gh pr comment` with your Bash tool to leave your review as a comment on the PR.

          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(gh api:*)"'

  security-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Minimize previous review comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}
          MARKER="<!-- claude-security-review -->"

          # Find the most recent comment containing our marker
          COMMENT_NODE_ID=$(gh api "repos/${REPO}/issues/${PR_NUMBER}/comments" \
            --paginate \
            --jq "[.[] | select(.body | contains(\"${MARKER}\"))] | last | .node_id // empty" 2>/dev/null)

          if [ -n "$COMMENT_NODE_ID" ]; then
            echo "Minimizing previous security review comment: $COMMENT_NODE_ID"
            gh api graphql -f query='
              mutation {
                minimizeComment(input: {subjectId: "'"$COMMENT_NODE_ID"'", classifier: OUTDATED}) {
                  minimizedComment { isMinimized }
                }
              }' 2>/dev/null || echo "Warning: failed to minimize comment"
          else
            echo "No previous security review comment found"
          fi

      - name: Run Claude Security Review
        id: claude-security-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_bots: "dependabot[bot]"
          prompt: |
            You are a security reviewer. Review this pull request for security vulnerabilities and concerns.

            Use the repository's CLAUDE.md for guidance on the codebase architecture.

            ## Comment Marker

            You MUST start your review comment with exactly this HTML comment on its own line:
            `<!-- claude-security-review -->`

            This marker is used to track and manage review comments across pushes. Do not omit it.

            ## Reading Previous Feedback

            Before writing your review, read all existing bot comments on this PR (including minimized ones) to understand what was previously flagged:

            ```
            gh api "repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" --paginate --jq '.[] | select(.user.type == "Bot") | "\n--- Comment from \(.created_at) ---\n\(.body)"'
            gh api "repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments" --paginate --jq '.[] | select(.user.type == "Bot") | "\n--- Comment on \(.path) from \(.created_at) ---\n\(.body)"'
            ```

            ## Formatting Rules

            Compare the current code against previously flagged issues and categorize:

            - **Previously flagged + now fixed** → show with ~~strikethrough~~ and a "Fixed" note
            - **Previously flagged + still present** → reference briefly without re-explaining
            - **New issues** → standard formatting with full explanation

            Structure your review using these sections (omit any section that has no items):

            ### Resolved
            Items previously flagged that are now fixed, shown with ~~strikethrough~~. Example:
            - ~~SQL injection risk in `query_users()`~~ — Fixed

            ### Still Open
            Previously flagged items **within the PR's changed code** that remain unaddressed.
            Do NOT include pre-existing issues outside the PR's scope here.

            ### New Issues
            Newly discovered problems **that must be fixed before merge**. Full explanation required.

            ### Suggestions
            Non-blocking observations: minor improvements, follow-up items, style preferences,
            or pre-existing issues noticed outside the PR scope. These do not block merge.

            If everything is clean and there are no issues in any category, post a short "All clear" message (still include the marker).

            ## Security Review Focus Areas
            - Injection vulnerabilities (SQL, command, XSS, template injection)
            - Authentication and authorization issues
            - Data exposure (secrets, PII in logs, information leakage)
            - Input validation at system boundaries
            - Dependency vulnerabilities
            - SSRF, path traversal, and other OWASP Top 10 issues

            Use `gh pr comment` with your Bash tool to leave your security review as a comment on the PR.

          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(gh api:*)"'

  review-gate:
    name: Review Gate
    needs: [code-review, security-review]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: read
    steps:
      - name: Evaluate reviews and gate merge
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}

          echo "=== Fetching CI reviewer comments ==="

          CODE_REVIEW=$(gh api "repos/${REPO}/issues/${PR_NUMBER}/comments" \
            --paginate \
            --jq '[.[] | select(.body | contains("<!-- claude-code-review -->"))] | last | .body // empty')

          SECURITY_REVIEW=$(gh api "repos/${REPO}/issues/${PR_NUMBER}/comments" \
            --paginate \
            --jq '[.[] | select(.body | contains("<!-- claude-security-review -->"))] | last | .body // empty')

          HAS_ISSUES=false

          # Check code review for unresolved issues
          if echo "$CODE_REVIEW" | grep -qE '### (New Issues|Still Open)'; then
            echo "::error::Code review has unresolved issues"
            HAS_ISSUES=true
          else
            echo "Code review: clean"
          fi

          # Check security review for unresolved issues
          if echo "$SECURITY_REVIEW" | grep -qE '### (New Issues|Still Open)'; then
            echo "::error::Security review has unresolved issues"
            HAS_ISSUES=true
          else
            echo "Security review: clean"
          fi

          if [ "$HAS_ISSUES" = true ]; then
            echo "::error::Review Gate FAILED — address the issues flagged by CI reviewers above."
            exit 1
          fi

          echo "Review Gate passed — all CI reviews clean."
