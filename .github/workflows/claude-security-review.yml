name: Claude Security Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  claude-security-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Minimize previous review comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}
          MARKER="<!-- claude-security-review -->"

          # Find the most recent comment containing our marker
          COMMENT_NODE_ID=$(gh api "repos/${REPO}/issues/${PR_NUMBER}/comments" \
            --paginate \
            --jq "[.[] | select(.body | contains(\"${MARKER}\"))] | last | .node_id // empty" 2>/dev/null)

          if [ -n "$COMMENT_NODE_ID" ]; then
            echo "Minimizing previous security review comment: $COMMENT_NODE_ID"
            gh api graphql -f query='
              mutation {
                minimizeComment(input: {subjectId: "'"$COMMENT_NODE_ID"'", classifier: OUTDATED}) {
                  minimizedComment { isMinimized }
                }
              }' 2>/dev/null || echo "Warning: failed to minimize comment"
          else
            echo "No previous security review comment found"
          fi

      - name: Run Claude Security Review
        id: claude-security-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            You are a security reviewer. Review this pull request for security vulnerabilities and concerns.

            Use the repository's CLAUDE.md for guidance on the codebase architecture.

            ## Comment Marker

            You MUST start your review comment with exactly this HTML comment on its own line:
            `<!-- claude-security-review -->`

            This marker is used to track and manage review comments across pushes. Do not omit it.

            ## Reading Previous Feedback

            Before writing your review, read all existing bot comments on this PR (including minimized ones) to understand what was previously flagged:

            ```
            gh api "repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" --paginate --jq '.[] | select(.user.type == "Bot") | "\n--- Comment from \(.created_at) ---\n\(.body)"'
            gh api "repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments" --paginate --jq '.[] | select(.user.type == "Bot") | "\n--- Comment on \(.path) from \(.created_at) ---\n\(.body)"'
            ```

            ## Formatting Rules

            Compare the current code against previously flagged issues and categorize:

            - **Previously flagged + now fixed** → show with ~~strikethrough~~ and a "Fixed" note
            - **Previously flagged + still present** → reference briefly without re-explaining
            - **New issues** → standard formatting with full explanation

            Structure your review using these sections (omit any section that has no items):

            ### Resolved
            Items previously flagged that are now fixed, shown with ~~strikethrough~~. Example:
            - ~~SQL injection risk in `query_users()`~~ — Fixed

            ### Still Open
            Previously flagged items that remain unaddressed. Reference only, no re-explanation.

            ### New Issues
            Newly discovered problems with full explanation.

            If everything is clean and there are no issues in any category, post a short "All clear" message (still include the marker).

            ## Security Review Focus Areas
            - Injection vulnerabilities (SQL, command, XSS, template injection)
            - Authentication and authorization issues
            - Data exposure (secrets, PII in logs, information leakage)
            - Input validation at system boundaries
            - Dependency vulnerabilities
            - SSRF, path traversal, and other OWASP Top 10 issues

            Use `gh pr comment` with your Bash tool to leave your security review as a comment on the PR.

          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(gh api:*)"'
