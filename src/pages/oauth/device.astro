---
import Layout from '../../layouts/Layout.astro';
import { TodoDB } from '../../lib/db.js';
import { Auth } from '../../lib/auth.js';

const url = new URL(Astro.request.url);
const userCodeParam = url.searchParams.get('user_code') || '';

// Check if user is authenticated (middleware should have redirected if not)
const sessionId = Auth.getSessionFromRequest(Astro.request);
const session = await Auth.getSessionUser(sessionId);

if (!session) {
  // This shouldn't happen as middleware redirects, but just in case
  const returnTo = url.pathname + url.search;
  const loginUrl = new URL('/login', url.origin);
  loginUrl.searchParams.set('return_to', returnTo);
  return Astro.redirect(loginUrl.toString());
}

const user = {
  id: session.user_id,
  username: session.username,
  email: session.email,
};

// If user_code was provided, look up the device authorization
let deviceAuth = null;
let error = null;

if (userCodeParam) {
  try {
    deviceAuth = await TodoDB.getDeviceAuthorizationByUserCode(userCodeParam);
    if (!deviceAuth) {
      error = 'Invalid or expired code. Please check the code and try again.';
    }
  } catch (err) {
    console.error('[OAuth/Device Page] Error looking up device code:', err);
    error = 'An error occurred. Please try again.';
  }
}

const scopes = deviceAuth ? JSON.parse(deviceAuth.scopes) : [];
---

<Layout title="Authorize Device">
  <div class="container">
    <div class="auth-container">
      <div class="card">
        <h1>Authorize Device</h1>

        {
          !deviceAuth && (
            <div class="code-entry">
              <p>Enter the code displayed on your device to authorize it.</p>

              {error && <div class="error-message">{error}</div>}

              <form method="GET" action="/oauth/device" class="code-form">
                <div class="form-group">
                  <label for="user_code">Device Code</label>
                  <input
                    type="text"
                    id="user_code"
                    name="user_code"
                    placeholder="XXXX-XXXX"
                    value={userCodeParam}
                    class="code-input"
                    maxlength="9"
                    pattern="[A-Za-z]{4}-?[A-Za-z]{4}"
                    required
                    autofocus
                  />
                  <small>The code is case-insensitive</small>
                </div>
                <button type="submit" class="btn btn-primary">
                  Continue
                </button>
              </form>
            </div>
          )
        }

        {
          deviceAuth && (
            <div class="authorization-content">
              <div class="client-info">
                <h2>{deviceAuth.client_name}</h2>
                <p>
                  This application is requesting access to your TaskManager
                  account via a device.
                </p>
              </div>

              <div class="code-display">
                <p>
                  Code:{' '}
                  <strong class="user-code">{deviceAuth.user_code}</strong>
                </p>
              </div>

              <div class="permissions">
                <h3>Requested Permissions:</h3>
                <ul class="scope-list">
                  {scopes.map((scopeItem: string) => (
                    <li class="scope-item">
                      {scopeItem === 'read' &&
                        'üìñ Read your todos and projects'}
                      {scopeItem === 'write' &&
                        '‚úèÔ∏è Create and modify your todos and projects'}
                      {scopeItem === 'delete' &&
                        'üóëÔ∏è Delete your todos and projects'}
                    </li>
                  ))}
                </ul>
              </div>

              <div class="user-info">
                <p>
                  Signed in as: <strong>{user.username}</strong>
                </p>
              </div>

              <form
                method="POST"
                action="/api/oauth/device/authorize"
                class="auth-form"
              >
                <input
                  type="hidden"
                  name="user_code"
                  value={deviceAuth.user_code}
                />

                <div class="button-group">
                  <button
                    type="submit"
                    name="action"
                    value="allow"
                    class="btn btn-primary"
                  >
                    Authorize Device
                  </button>
                  <button
                    type="submit"
                    name="action"
                    value="deny"
                    class="btn btn-secondary"
                  >
                    Deny
                  </button>
                </div>
              </form>

              <div class="security-note">
                <p>
                  <small>
                    ‚ö†Ô∏è Only authorize devices you trust. The device will have
                    access to your account until you revoke it.
                  </small>
                </p>
              </div>
            </div>
          )
        }
      </div>
    </div>
  </div>
</Layout>

<style>
  .code-entry {
    text-align: center;
  }

  .code-form {
    margin-top: 1.5rem;
  }

  .form-group {
    margin-bottom: 1rem;
    text-align: left;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
  }

  .code-input {
    width: 100%;
    padding: 1rem;
    font-size: 1.5rem;
    font-family: monospace;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    border: 2px solid var(--border-color, #e2e8f0);
    border-radius: 0.5rem;
    background: var(--input-bg, #fff);
  }

  .code-input:focus {
    outline: none;
    border-color: var(--primary-color, #3b82f6);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .form-group small {
    display: block;
    margin-top: 0.5rem;
    color: var(--text-muted, #64748b);
  }

  .error-message {
    background-color: #fef2f2;
    border: 1px solid #fecaca;
    color: #dc2626;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
  }

  .code-display {
    background-color: var(--bg-secondary, #f8fafc);
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    margin-bottom: 1.5rem;
    text-align: center;
  }

  .user-code {
    font-family: monospace;
    font-size: 1.25rem;
    letter-spacing: 0.1em;
  }

  .client-info {
    margin-bottom: 1.5rem;
  }

  .client-info h2 {
    margin-bottom: 0.5rem;
  }

  .permissions {
    margin-bottom: 1.5rem;
    padding: 1rem;
    background-color: var(--bg-secondary, #f8fafc);
    border-radius: 0.5rem;
  }

  .permissions h3 {
    margin-bottom: 0.75rem;
    font-size: 1rem;
  }

  .scope-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .scope-item {
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border-color, #e2e8f0);
  }

  .scope-item:last-child {
    border-bottom: none;
  }

  .user-info {
    margin-bottom: 1.5rem;
    padding: 0.75rem 1rem;
    background-color: var(--bg-secondary, #f8fafc);
    border-radius: 0.5rem;
    text-align: center;
  }

  .button-group {
    display: flex;
    gap: 1rem;
    justify-content: center;
  }

  .btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 0.5rem;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .btn-primary {
    background-color: var(--primary-color, #3b82f6);
    color: white;
  }

  .btn-primary:hover {
    background-color: var(--primary-hover, #2563eb);
  }

  .btn-secondary {
    background-color: var(--secondary-color, #64748b);
    color: white;
  }

  .btn-secondary:hover {
    background-color: var(--secondary-hover, #475569);
  }

  .security-note {
    margin-top: 1.5rem;
    text-align: center;
    color: var(--text-muted, #64748b);
  }

  .auth-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 60vh;
    padding: 2rem;
  }

  .card {
    max-width: 480px;
    width: 100%;
    padding: 2rem;
    background: var(--card-bg, white);
    border-radius: 1rem;
    box-shadow:
      0 4px 6px -1px rgba(0, 0, 0, 0.1),
      0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  .card h1 {
    text-align: center;
    margin-bottom: 1.5rem;
  }
</style>
