services:
  # ========== FASTAPI BACKEND ==========
  backend:
    build:
      context: ./services/backend
      dockerfile: Dockerfile
    container_name: taskmanager-backend
    restart: unless-stopped
    ports:
      - '8000:8000'
    env_file:
      - .env
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_PORT=5432
      - SECRET_KEY=${SECRET_KEY:-your-secret-key-change-in-production}
      - ENVIRONMENT=production
      - DEBUG=false
      - FRONTEND_URL=${FRONTEND_URL:-https://todo.brooksmcmillin.com}
      - UPLOAD_DIR=/app/uploads
    volumes:
      - uploads_data:/app/uploads
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - taskmanager_network

  # ========== SVELTEKIT FRONTEND ==========
  frontend:
    build:
      context: ./services/frontend
      dockerfile: Dockerfile
    container_name: taskmanager-frontend
    restart: unless-stopped
    ports:
      - '3000:3000'
    environment:
      - BACKEND_URL=http://backend:8000
      - VITE_API_URL=http://backend:8000
      - PUBLIC_APP_NAME=TaskManager
      - ORIGIN=${FRONTEND_URL:-https://todo.brooksmcmillin.com}
    depends_on:
      - backend
    networks:
      - taskmanager_network

  postgres:
    image: pgvector/pgvector:pg15
    container_name: postgres_db
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./services/db/certs/server.crt:/var/lib/postgresql/server.crt:ro
      - ./services/db/certs/server.key:/var/lib/postgresql/server.key:ro
    command: >
      postgres
      -c ssl=on
      -c ssl_cert_file=/var/lib/postgresql/server.crt
      -c ssl_key_file=/var/lib/postgresql/server.key
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - taskmanager_network

  mcp-auth:
    build:
      context: .
      dockerfile: services/mcp-auth/Dockerfile
    container_name: taskmanager-mcp-auth
    command: uv run --no-sync python -m mcp_auth.auth_server --port 9000 --taskmanager-url http://backend:8000
    ports:
      - '9000:9000'
    environment:
      - TASKMANAGER_CLIENT_ID=${TASKMANAGER_CLIENT_ID}
      - TASKMANAGER_CLIENT_SECRET=${TASKMANAGER_CLIENT_SECRET}
      - TASKMANAGER_OAUTH_HOST=${TASKMANAGER_OAUTH_HOST}
      - MCP_SERVER=http://mcp-resource:8001
      - MCP_AUTH_SERVER_URL=${MCP_AUTH_SERVER_PUBLIC_URL:-http://localhost:9000}
      - DATABASE_URL=${DATABASE_URL:-postgresql://taskmanager:password@postgres:5432/taskmanager}
    env_file:
      - .env
    depends_on:
      - backend
      - postgres
    networks:
      - taskmanager_network
    restart: unless-stopped

  mcp-resource:
    build:
      context: .
      dockerfile: services/mcp-resource/Dockerfile
    container_name: taskmanager-mcp-resource
    command: uv run --no-sync python -m mcp_resource.server --port 8001 --auth-server http://mcp-auth:9000 --auth-server-public-url ${MCP_AUTH_SERVER_PUBLIC_URL:-http://localhost:9000}
    ports:
      - '8001:8001'
    environment:
      - TASKMANAGER_CLIENT_ID=${TASKMANAGER_CLIENT_ID}
      - TASKMANAGER_CLIENT_SECRET=${TASKMANAGER_CLIENT_SECRET}
      - TASKMANAGER_OAUTH_HOST=${TASKMANAGER_OAUTH_HOST}
      - TASKMANAGER_API_KEY=${TASKMANAGER_API_KEY}
      - MCP_AUTH_SERVER=http://mcp-auth:9000
      - MCP_SERVER_URL=${MCP_SERVER_URL:-http://localhost:8001}
      - MCP_AUTH_SERVER_PUBLIC_URL=${MCP_AUTH_SERVER_PUBLIC_URL:-http://localhost:9000}
    env_file:
      - .env
    depends_on:
      - mcp-auth
    networks:
      - taskmanager_network
    restart: unless-stopped

volumes:
  postgres_data:
    external: true
    name: db_postgres_data
  uploads_data:

networks:
  taskmanager_network:
    driver: bridge
