services:
  # ========== FASTAPI BACKEND ==========
  backend:
    build:
      context: ./services/backend
      dockerfile: Dockerfile
    container_name: taskmanager-backend
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_PORT=5432
      - SECRET_KEY=${SECRET_KEY:-your-secret-key-change-in-production}
      - ENVIRONMENT=production
      - DEBUG=false
      - FRONTEND_URL=${FRONTEND_URL:-https://todo.brooksmcmillin.com}
      - UPLOAD_DIR=/app/uploads
    volumes:
      - uploads_data:/app/uploads
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - taskmanager_network
      - proxy
    labels:
      - traefik.enable=true
      - traefik.http.routers.tm-api.rule=Host(`api.brooksmcmillin.com`)
      - traefik.http.routers.tm-api.tls.certresolver=letsencrypt
      - traefik.http.routers.tm-api.middlewares=security-headers@file
      - traefik.http.services.tm-api.loadbalancer.server.port=8000

  # ========== SVELTEKIT FRONTEND ==========
  frontend:
    build:
      context: ./services/frontend
      dockerfile: Dockerfile
    container_name: taskmanager-frontend
    restart: unless-stopped
    environment:
      - BACKEND_URL=http://backend:8000
      - VITE_API_URL=http://backend:8000
      - PUBLIC_APP_NAME=TaskManager
      - ORIGIN=${FRONTEND_URL:-https://todo.brooksmcmillin.com}
    depends_on:
      - backend
    networks:
      - taskmanager_network
      - proxy
    labels:
      - traefik.enable=true
      - traefik.http.routers.tm-frontend.rule=Host(`todo.brooksmcmillin.com`)
      - traefik.http.routers.tm-frontend.tls.certresolver=letsencrypt
      - traefik.http.routers.tm-frontend.middlewares=security-headers@file
      - traefik.http.services.tm-frontend.loadbalancer.server.port=3000

  postgres:
    image: pgvector/pgvector:pg15
    container_name: postgres_db
    restart: unless-stopped
    ports:
      - '127.0.0.1:5432:5432'
    env_file:
      - .env
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./services/db/certs/server.crt:/var/lib/postgresql/server.crt:ro
      - ./services/db/certs/server.key:/var/lib/postgresql/server.key:ro
    command: >
      postgres
      -c ssl=on
      -c ssl_cert_file=/var/lib/postgresql/server.crt
      -c ssl_key_file=/var/lib/postgresql/server.key
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - taskmanager_network

  mcp-auth:
    build:
      context: .
      dockerfile: services/mcp-auth/Dockerfile
    container_name: taskmanager-mcp-auth
    command: uv run --no-sync python -m mcp_auth.auth_server --port 9000 --taskmanager-url http://backend:8000
    environment:
      - TASKMANAGER_CLIENT_ID=${TASKMANAGER_CLIENT_ID}
      - TASKMANAGER_CLIENT_SECRET=${TASKMANAGER_CLIENT_SECRET}
      - TASKMANAGER_OAUTH_HOST=${TASKMANAGER_OAUTH_HOST}
      - MCP_SERVER=http://mcp-resource:8001
      - MCP_AUTH_SERVER_URL=${MCP_AUTH_SERVER_PUBLIC_URL:-http://localhost:9000}
      - DATABASE_URL=${DATABASE_URL:-postgresql://taskmanager:password@postgres:5432/taskmanager}
    env_file:
      - .env
    depends_on:
      - backend
      - postgres
    networks:
      - taskmanager_network
      - proxy
    labels:
      - traefik.enable=true
      - traefik.http.routers.tm-mcp-auth.rule=Host(`mcp-auth.brooksmcmillin.com`)
      - traefik.http.routers.tm-mcp-auth.tls.certresolver=letsencrypt
      - traefik.http.routers.tm-mcp-auth.middlewares=security-headers@file
      - traefik.http.services.tm-mcp-auth.loadbalancer.server.port=9000
    restart: unless-stopped

  mcp-resource:
    build:
      context: .
      dockerfile: services/mcp-resource/Dockerfile
    container_name: taskmanager-mcp-resource
    command: uv run --no-sync python -m mcp_resource.server --port 8001 --auth-server http://mcp-auth:9000 --auth-server-public-url ${MCP_AUTH_SERVER_PUBLIC_URL:-http://localhost:9000}
    environment:
      - TASKMANAGER_CLIENT_ID=${TASKMANAGER_CLIENT_ID}
      - TASKMANAGER_CLIENT_SECRET=${TASKMANAGER_CLIENT_SECRET}
      - TASKMANAGER_OAUTH_HOST=${TASKMANAGER_OAUTH_HOST}
      - TASKMANAGER_API_KEY=${TASKMANAGER_API_KEY}
      - MCP_AUTH_SERVER=http://mcp-auth:9000
      - MCP_SERVER_URL=${MCP_SERVER_URL:-http://localhost:8001}
      - MCP_AUTH_SERVER_PUBLIC_URL=${MCP_AUTH_SERVER_PUBLIC_URL:-http://localhost:9000}
    env_file:
      - .env
    depends_on:
      - mcp-auth
    networks:
      - taskmanager_network
      - proxy
    labels:
      - traefik.enable=true
      - traefik.http.routers.tm-mcp.rule=Host(`mcp.brooksmcmillin.com`)
      - traefik.http.routers.tm-mcp.tls.certresolver=letsencrypt
      - traefik.http.routers.tm-mcp.middlewares=security-headers@file,mcp-cors@file
      - traefik.http.services.tm-mcp.loadbalancer.server.port=8001
    restart: unless-stopped

  # ========== MCP RELAY (dev tool) ==========
  mcp-relay:
    build:
      context: .
      dockerfile: services/mcp-relay/Dockerfile
    container_name: taskmanager-mcp-relay
    command: uv run --no-sync python -m mcp_relay.server --port 8002 --auth-server http://mcp-auth:9000 --auth-server-public-url ${MCP_AUTH_SERVER_PUBLIC_URL:-http://localhost:9000} --server-url ${MCP_RELAY_SERVER_URL:-http://localhost:8002}
    ports:
      - '127.0.0.1:8002:8002'
    environment:
      - MAX_MESSAGES_PER_CHANNEL=${MAX_MESSAGES_PER_CHANNEL:-1000}
      - MAX_CHANNELS=${MAX_CHANNELS:-100}
      - MCP_AUTH_SERVER=http://mcp-auth:9000
      - MCP_AUTH_SERVER_PUBLIC_URL=${MCP_AUTH_SERVER_PUBLIC_URL:-http://localhost:9000}
    depends_on:
      - mcp-auth
    networks:
      - taskmanager_network
      - proxy
    labels:
      - traefik.enable=true
      - traefik.http.routers.tm-mcp-relay.rule=Host(`mcp-relay.brooksmcmillin.com`) && !PathPrefix(`/debug`)
      - traefik.http.routers.tm-mcp-relay.tls.certresolver=letsencrypt
      - traefik.http.routers.tm-mcp-relay.middlewares=security-headers@file,mcp-cors@file
      - traefik.http.services.tm-mcp-relay.loadbalancer.server.port=8002
    restart: unless-stopped

  # ========== MONITORING STACK ==========
  prometheus:
    image: prom/prometheus:latest
    container_name: taskmanager-prometheus
    restart: unless-stopped
    volumes:
      - ./services/monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
    networks:
      - taskmanager_network

  loki:
    image: grafana/loki:3.0.0
    container_name: taskmanager-loki
    restart: unless-stopped
    volumes:
      - ./services/monitoring/loki/loki-config.yml:/etc/loki/local-config.yaml:ro
      - loki_data:/loki
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - taskmanager_network
      - proxy
    labels:
      - traefik.enable=false

  promtail:
    image: grafana/promtail:3.0.0
    container_name: taskmanager-promtail
    restart: unless-stopped
    # SECURITY: Docker socket mount grants container-level read access to all
    # container metadata and logs. In production, run Promtail in a restricted
    # network and consider using a socket proxy (e.g., tecnativa/docker-socket-proxy)
    # to limit API access.
    volumes:
      - ./services/monitoring/promtail/promtail-config.yml:/etc/promtail/config.yml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command: -config.file=/etc/promtail/config.yml
    depends_on:
      - loki
    networks:
      - taskmanager_network

  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: taskmanager-postgres-exporter
    restart: unless-stopped
    environment:
      - DATA_SOURCE_NAME=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}?sslmode=require
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - taskmanager_network

  grafana:
    image: grafana/grafana:latest
    container_name: taskmanager-grafana
    restart: unless-stopped
    ports:
      - '127.0.0.1:3001:3000'
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./services/monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
    depends_on:
      - prometheus
      - loki
    networks:
      - taskmanager_network

volumes:
  postgres_data:
    external: true
    name: db_postgres_data
  uploads_data:
  prometheus_data:
  loki_data:
  grafana_data:

networks:
  taskmanager_network:
    driver: bridge
  proxy:
    external: true
