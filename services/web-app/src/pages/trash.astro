---
// src/pages/trash.astro - View and restore deleted tasks
import Layout from '../layouts/Layout.astro';
import { checkAuthAsync } from '../lib/auth.js';

const auth = await checkAuthAsync(Astro.request);
if (auth.redirect) return auth.redirect;
const user = auth.user;
---

<Layout title="Deleted Tasks" user={user}>
  <main class="container py-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-8">Deleted Tasks</h1>

    <!-- Search Bar -->
    <div class="max-w-4xl mx-auto mb-6">
      <div class="flex gap-4">
        <input
          type="text"
          id="search-input"
          placeholder="Search deleted tasks..."
          class="form-input flex-1"
        />
        <button id="search-btn" class="btn btn-primary">Search</button>
        <button id="clear-btn" class="btn btn-secondary hidden">Clear</button>
      </div>
    </div>

    <!-- Deleted Tasks List -->
    <div class="max-w-4xl mx-auto">
      <div id="trash-list" class="space-y-4">
        <!-- Deleted tasks will be loaded here -->
      </div>
      <div id="empty-state" class="hidden text-center py-8 text-gray-500">
        <p>No deleted tasks found.</p>
      </div>
    </div>
  </main>
</Layout>

<script>
  // Escape HTML to prevent XSS
  function escapeHtml(unsafe) {
    if (unsafe == null) return '';
    return String(unsafe)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  function formatDateForDisplay(dateStr) {
    if (!dateStr) return '';
    const [year, month, day] = dateStr.split('-').map(Number);
    const date = new Date(year, month - 1, day);
    return date.toLocaleDateString();
  }

  function getPriorityBadgeClass(priority) {
    switch (priority) {
      case 'urgent':
        return 'bg-red-100 text-red-800';
      case 'high':
        return 'bg-orange-100 text-orange-800';
      case 'medium':
        return 'bg-yellow-100 text-yellow-800';
      case 'low':
        return 'bg-green-100 text-green-800';
      default:
        return 'bg-gray-100 text-gray-800';
    }
  }

  async function loadDeletedTasks(query = '') {
    try {
      const url = query
        ? `/api/trash?query=${encodeURIComponent(query)}`
        : '/api/trash';
      const response = await fetch(url);

      if (!response.ok) {
        if (response.status === 401) {
          window.location.href = '/login';
          return;
        }
        throw new Error('Failed to load deleted tasks');
      }

      const data = await response.json();
      const tasks = data.tasks || [];
      const container = document.getElementById('trash-list');
      const emptyState = document.getElementById('empty-state');

      container.innerHTML = '';

      if (tasks.length === 0) {
        container.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
      }

      container.classList.remove('hidden');
      emptyState.classList.add('hidden');

      tasks.forEach((task) => {
        const taskDiv = document.createElement('div');
        taskDiv.className = 'card border-l-4';
        taskDiv.style.borderLeftColor = task.project_color || '#9ca3af';

        const priorityBadge = `<span class="text-xs px-2 py-1 rounded ${getPriorityBadgeClass(task.priority)}">${escapeHtml(task.priority)}</span>`;

        taskDiv.innerHTML = `
          <div class="flex items-start justify-between gap-4">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <h3 class="font-semibold text-lg text-gray-800 truncate">${escapeHtml(task.title)}</h3>
                ${priorityBadge}
              </div>
              <p class="text-gray-600 text-sm mt-1 line-clamp-2">${escapeHtml(task.description) || 'No description'}</p>
              <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs text-gray-500 mt-3">
                ${task.project_name ? `<span>Project: ${escapeHtml(task.project_name)}</span>` : ''}
                ${task.due_date ? `<span>Due: ${formatDateForDisplay(task.due_date)}</span>` : ''}
                <span>Deleted: ${formatDateForDisplay(task.deleted_at)}</span>
              </div>
            </div>
            <div class="flex-shrink-0">
              <button
                onclick="restoreTask(${parseInt(task.id, 10)})"
                class="btn btn-primary btn-sm"
                title="Restore task"
              >
                Restore
              </button>
            </div>
          </div>
        `;

        container.appendChild(taskDiv);
      });
    } catch (error) {
      console.error('Failed to load deleted tasks:', error);
      document.getElementById('trash-list').innerHTML =
        '<p class="text-red-500">Failed to load deleted tasks</p>';
      document.getElementById('empty-state').classList.add('hidden');
    }
  }

  window.restoreTask = async function (taskId) {
    try {
      const response = await fetch(`/api/trash/${taskId}/restore`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
      });

      if (response.ok) {
        // Reload the list after successful restore
        const searchInput = document.getElementById('search-input');
        loadDeletedTasks(searchInput.value.trim());
      } else if (response.status === 401) {
        window.location.href = '/login';
      } else {
        const data = await response.json();
        alert(data.error?.message || 'Failed to restore task');
      }
    } catch (error) {
      alert('Error: ' + error.message);
    }
  };

  // Search functionality
  const searchInput = document.getElementById('search-input');
  const searchBtn = document.getElementById('search-btn');
  const clearBtn = document.getElementById('clear-btn');

  searchBtn.addEventListener('click', () => {
    const query = searchInput.value.trim();
    if (query) {
      loadDeletedTasks(query);
      clearBtn.classList.remove('hidden');
    } else {
      loadDeletedTasks();
    }
  });

  searchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      searchBtn.click();
    }
  });

  clearBtn.addEventListener('click', () => {
    searchInput.value = '';
    clearBtn.classList.add('hidden');
    loadDeletedTasks();
  });

  // Load deleted tasks on page load
  loadDeletedTasks();
</script>
